<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuiper Expression Evaluator</title>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            100: '#d5d5d5',
                            200: '#a6a6a6',
                            300: '#7a7a7a',
                            400: '#4d4d4d',
                            500: '#333333',
                            600: '#262626',
                            700: '#1a1a1a',
                            800: '#0d0d0d',
                            900: '#000000',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        .editor {
            height: 100%;
            border: 1px solid #474747;
            border-radius: 4px;
        }

        .resizer {
            width: 10px;
            background-color: #474747;
            cursor: col-resize;
            transition: background-color 0.3s;
        }

        .resizer:hover,
        .resizer.resizing {
            background-color: #666;
        }

        .column {
            overflow: hidden;
        }

        .modal {
            transition: opacity 0.25s ease;
        }

        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
    </style>
</head>

<body class="bg-dark-800 text-gray-200 h-full flex flex-col">
    <!-- Topbar -->
    <div class="bg-dark-700 p-4 flex justify-between items-center">
        <h1 class="text-xl font-bold">Kuiper Expression Evaluator</h1>
        <button id="settingsBtn"
            class="text-gray-300 hover:text-white p-2 rounded-full hover:bg-dark-600 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="feather feather-settings">
                <circle cx="12" cy="12" r="3"></circle>
                <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                </path>
            </svg>
        </button>
    </div>

    <!-- Main Container -->
    <div class="flex flex-1 overflow-hidden">
        <!-- GraphQL Column -->
        <div id="graphqlColumn" class="column flex flex-col p-4" style="flex: 1;">
            <label for="graphqlUrl" class="block mb-2 font-semibold">GraphQL URL</label>
            <input type="text" id="graphqlUrl" class="bg-dark-700 text-gray-200 rounded p-2 mb-4"
                placeholder="Enter GraphQL URL">
            <label for="graphqlQuery" class="block mb-2 font-semibold">GraphQL Query</label>
            <div id="graphqlQuery" class="editor flex-grow mb-4"></div>
            <button id="sendGraphQLBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                Send GraphQL Query
            </button>
        </div>
        <!-- Resizer -->
        <div class="resizer" id="resizer1"></div>
        <!-- JSON Data Column -->
        <div id="jsonColumn" class="column flex flex-col p-4" style="flex: 1;">
            <label for="jsonData" class="block mb-2 font-semibold">JSON Data</label>
            <div id="jsonData" class="editor flex-grow"></div>
        </div>
        <!-- Resizer -->
        <div class="resizer" id="resizer2"></div>
        <!-- Expression and Result Column -->
        <div id="expressionColumn" class="column flex flex-col p-4" style="flex: 1;">
            <div class="h-1/2 flex flex-col">
                <label for="expression" class="block mb-2 font-semibold">Kuiper Expression</label>
                <div id="expression" class="editor flex-grow mb-4"></div>
                <button id="evaluateBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Evaluate
                </button>
            </div>
            <div class="h-1/2 flex flex-col mt-4">
                <label for="result" class="block mb-2 font-semibold">Result</label>
                <div id="result" class="editor flex-grow"></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="settingsModal"
        class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>

        <div class="modal-container bg-dark-700 w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">Settings</p>
                    <div id="closeModal" class="modal-close cursor-pointer z-50">
                        <svg class="fill-current text-white" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                            viewBox="0 0 18 18">
                            <path
                                d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z">
                            </path>
                        </svg>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-bold mb-2" for="bearerToken">
                        Bearer Token
                    </label>
                    <input
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        id="bearerToken" type="password" placeholder="Enter your bearer token">
                </div>

                <div class="flex justify-end pt-2">
                    <button id="saveSettings"
                        class="px-4 bg-blue-500 p-3 rounded-lg text-white hover:bg-blue-400">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            // Initialize editors (same as before)
            const graphqlEditor = monaco.editor.create(document.getElementById('graphqlQuery'), {
                value: '# Enter your GraphQL query here',
                language: 'graphql',
                theme: 'vs-dark',
                automaticLayout: true
            });

            const jsonEditor = monaco.editor.create(document.getElementById('jsonData'), {
                value: '{}',
                language: 'json',
                theme: 'vs-dark',
                automaticLayout: true
            });

            const expressionEditor = monaco.editor.create(document.getElementById('expression'), {
                value: 'input',
                language: 'javascript',
                theme: 'vs-dark',
                automaticLayout: true
            });

            const resultEditor = monaco.editor.create(document.getElementById('result'), {
                value: 'Result will appear here',
                language: 'json',
                theme: 'vs-dark',
                readOnly: true,
                automaticLayout: true
            });

            // Resizable columns functionality (same as before)
            function makeResizable(resizer, leftColumn, rightColumn) {
                let x = 0;
                let leftWidth = 0;

                const mouseDownHandler = function (e) {
                    x = e.clientX;
                    leftWidth = leftColumn.getBoundingClientRect().width;

                    document.addEventListener('mousemove', mouseMoveHandler);
                    document.addEventListener('mouseup', mouseUpHandler);

                    resizer.classList.add('resizing');
                };

                const mouseMoveHandler = function (e) {
                    const dx = e.clientX - x;
                    const newLeftWidth = ((leftWidth + dx) / resizer.parentNode.getBoundingClientRect().width) * 100;
                    leftColumn.style.flex = `0 0 ${newLeftWidth}%`;
                    rightColumn.style.flex = `1 1 0`;
                };

                const mouseUpHandler = function () {
                    document.removeEventListener('mousemove', mouseMoveHandler);
                    document.removeEventListener('mouseup', mouseUpHandler);

                    resizer.classList.remove('resizing');
                };

                resizer.addEventListener('mousedown', mouseDownHandler);
            }

            // Setup resizable columns
            const resizer1 = document.getElementById('resizer1');
            const resizer2 = document.getElementById('resizer2');
            const graphqlColumn = document.getElementById('graphqlColumn');
            const jsonColumn = document.getElementById('jsonColumn');
            const expressionColumn = document.getElementById('expressionColumn');

            makeResizable(resizer1, graphqlColumn, jsonColumn);
            makeResizable(resizer2, jsonColumn, expressionColumn);

            // Modal functionality
            let bearerToken = '';
            const modal = document.getElementById('settingsModal');
            const settingsBtn = document.getElementById('settingsBtn');
            const closeModal = document.getElementById('closeModal');
            const saveSettings = document.getElementById('saveSettings');

            settingsBtn.onclick = function () {
                modal.classList.remove('opacity-0', 'pointer-events-none');
                document.body.classList.add('modal-active');
            }

            closeModal.onclick = function () {
                modal.classList.add('opacity-0', 'pointer-events-none');
                document.body.classList.remove('modal-active');
            }

            saveSettings.onclick = function () {
                bearerToken = document.getElementById('bearerToken').value;
                modal.classList.add('opacity-0', 'pointer-events-none');
                document.body.classList.remove('modal-active');
            }

            // Handle Send GraphQL Query Button Click
            document.getElementById('sendGraphQLBtn').addEventListener('click', function () {
                const url = document.getElementById('graphqlUrl').value;
                const query = graphqlEditor.getValue();

                fetch('/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${bearerToken}`
                    },
                    body: JSON.stringify({
                        url: url,
                        query: query
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        jsonEditor.setValue(JSON.stringify(data, null, 2));
                    })
                    .catch(error => {
                        jsonEditor.setValue(JSON.stringify({ error: 'An error occurred while fetching GraphQL data.' }, null, 2));
                    });
            });

            // Handle Evaluate Button Click
            document.getElementById('evaluateBtn').addEventListener('click', function () {
                const jsonData = jsonEditor.getValue();
                const expression = expressionEditor.getValue();

                fetch('/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        jsonData: jsonData,
                        expression: expression
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            resultEditor.setValue(JSON.stringify(data, null, 2));
                        } else {
                            resultEditor.setValue(JSON.stringify(data, null, 2));
                        }
                    })
                    .catch(error => {
                        resultEditor.setValue(JSON.stringify({ error: 'An error occurred while evaluating the expression.' }, null, 2));
                    });
            });

            // Initialize Feather icons
            feather.replace();
        });
    </script>
</body>

</html>